# Azure Pipelines YAML for MuleSoft Projects
# ‚úÖ Complete pipeline with Maven 3.9.10 + All features enabled
# ‚úÖ MUnit Tests, SonarQube, API Governance, CloudHub Deployment

trigger:
  branches:
    include:
      - '*'

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: build.variables
  - name: disable.coverage.autogenerate
    value: 'true'
  - name: MAVEN_VERSION
    value: '3.9.10'
  - name: MAVEN_CACHE_FOLDER
    value: $(Pipeline.Workspace)/.m2/repository
  - name: MAVEN_HOME
    value: /opt/maven
  - name: PROJECT_NAME
    value: $[variables.projectName]
  - name: MULE_ORG
    value: $[variables.muleOrg]
  - name: MULE_ORG_ID
    value: $[variables.muleOrgId]

stages:
  #####################################################
  # BUILD STAGE
  #####################################################
  - stage: Build
    displayName: 'Build and Test Stage'
    jobs:
      - job: BuildAndTest
        displayName: 'Build and Test Job'
        steps:
          # =============================================
          # STEP 1: Download settings.xml (Secure Files)
          # =============================================
          - task: DownloadSecureFile@1
            name: mavenSettings
            displayName: 'Download Maven Settings from Secure Files'
            inputs:
              secureFile: 'settings.xml'
          
          # =============================================
          # STEP 2: Install Maven 3.9.10 (Robust)
          # =============================================
          - script: |
              set -e
              
              echo "=================================================="
              echo "  Installing Maven $(MAVEN_VERSION)"
              echo "=================================================="
              echo ""
              
              # Show current state
              echo "üìã Pre-installed Maven:"
              mvn --version 2>/dev/null || echo "   Not found"
              echo ""
              
              # Download configuration
              MAVEN_URL="https://archive.apache.org/dist/maven/maven-3/$(MAVEN_VERSION)/binaries/apache-maven-$(MAVEN_VERSION)-bin.tar.gz"
              MAVEN_ARCHIVE="maven.tar.gz"
              MAVEN_DIR="apache-maven-$(MAVEN_VERSION)"
              
              echo "üì• Downloading Maven $(MAVEN_VERSION)..."
              
              # Try wget first
              if wget --progress=dot:giga --timeout=60 --tries=3 -O "$MAVEN_ARCHIVE" "$MAVEN_URL"; then
                echo "‚úÖ Downloaded with wget"
              elif curl -fsSL --progress-bar --max-time 120 --retry 3 -o "$MAVEN_ARCHIVE" "$MAVEN_URL"; then
                echo "‚úÖ Downloaded with curl"
              else
                echo "‚ùå ERROR: Download failed with both wget and curl"
                exit 1
              fi
              
              # Verify download
              FILE_SIZE=$(stat -c%s "$MAVEN_ARCHIVE" 2>/dev/null || stat -f%z "$MAVEN_ARCHIVE" 2>/dev/null)
              echo "   File size: $(echo $FILE_SIZE | numfmt --to=iec-i --suffix=B 2>/dev/null || echo ${FILE_SIZE} bytes)"
              
              if [ "$FILE_SIZE" -lt 8000000 ]; then
                echo "‚ùå ERROR: File too small ($FILE_SIZE bytes)"
                exit 1
              fi
              
              # Extract
              echo ""
              echo "üì¶ Extracting..."
              tar -xzf "$MAVEN_ARCHIVE"
              
              if [ ! -d "$MAVEN_DIR" ]; then
                echo "‚ùå ERROR: Directory not found after extraction"
                ls -la
                exit 1
              fi
              
              # Install
              echo "üì• Installing to $(MAVEN_HOME)..."
              sudo rm -rf $(MAVEN_HOME) 2>/dev/null || true
              sudo mv "$MAVEN_DIR" $(MAVEN_HOME)
              sudo chmod -R 755 $(MAVEN_HOME)
              
              # Verify
              if [ ! -f $(MAVEN_HOME)/bin/mvn ]; then
                echo "‚ùå ERROR: Maven binary not found"
                exit 1
              fi
              
              echo ""
              echo "‚úÖ Maven installed:"
              $(MAVEN_HOME)/bin/mvn --version
              
              # Verify version
              ACTUAL_VERSION=$($(MAVEN_HOME)/bin/mvn --version | grep "Apache Maven" | awk '{print $3}')
              if [ "$ACTUAL_VERSION" = "$(MAVEN_VERSION)" ]; then
                echo "‚úÖ Version verified: $ACTUAL_VERSION"
              else
                echo "‚ö†Ô∏è Version mismatch (expected $(MAVEN_VERSION), got $ACTUAL_VERSION)"
              fi
              
              # Cleanup
              rm -f "$MAVEN_ARCHIVE"
              echo ""
              echo "‚úÖ Installation complete"
              
            displayName: 'Install Maven 3.9.10'
          
          # =============================================
          # STEP 3: Install settings.xml
          # =============================================
          - script: |
              echo "üì¶ Installing Maven settings.xml..."
              mkdir -p ~/.m2
              
              if [ ! -f "$(mavenSettings.secureFilePath)" ]; then
                echo "‚ùå ERROR: settings.xml not found"
                exit 1
              fi
              
              cp $(mavenSettings.secureFilePath) ~/.m2/settings.xml
              
              if [ -f ~/.m2/settings.xml ]; then
                echo "‚úÖ settings.xml installed"
                echo "   Location: ~/.m2/settings.xml"
                FILE_SIZE=$(stat -c%s ~/.m2/settings.xml 2>/dev/null || stat -f%z ~/.m2/settings.xml 2>/dev/null)
                echo "   Size: $FILE_SIZE bytes"
              else
                echo "‚ùå ERROR: Installation failed"
                exit 1
              fi
              
              echo ""
              echo "üìÑ Structure (sanitized):"
              grep -E '<server>|<id>|</server>' ~/.m2/settings.xml | head -20 || echo "   Could not parse"
              
            displayName: 'Install Maven Settings'

          # =============================================
          # STEP 4: Setup Java 17
          # =============================================
          - task: JavaToolInstaller@0
            displayName: 'Install Java 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          # =============================================
          # STEP 5: Verify Environment
          # =============================================
          - script: |
              echo "=================================================="
              echo "  Build Environment"
              echo "=================================================="
              echo ""
              
              echo "‚òï Java:"
              java -version 2>&1 | head -3
              echo "   JAVA_HOME: $JAVA_HOME"
              echo ""
              
              echo "üì¶ Maven:"
              export M2_HOME=$(MAVEN_HOME)
              export PATH=$(MAVEN_HOME)/bin:$PATH
              mvn --version
              echo "   M2_HOME: $M2_HOME"
              echo ""
              
              echo "‚öôÔ∏è Settings:"
              if [ -f ~/.m2/settings.xml ]; then
                echo "   ‚úÖ settings.xml exists"
              else
                echo "   ‚ùå settings.xml missing"
                exit 1
              fi
              echo ""
              
              echo "üìã POM:"
              if [ -f pom.xml ]; then
                echo "   ‚úÖ pom.xml found"
                grep -E "mule.maven.plugin.version|maven.compiler.source|app.runtime" pom.xml | head -5 || true
              else
                echo "   ‚ö†Ô∏è pom.xml not found"
              fi
              
              echo ""
              echo "‚úÖ Verification complete"
              
            displayName: 'Verify Build Environment'
            env:
              M2_HOME: $(MAVEN_HOME)

          # =============================================
          # STEP 6: Cache Maven Dependencies
          # =============================================
          - task: Cache@2
            displayName: 'Cache Maven Dependencies'
            inputs:
              key: 'maven | "$(Agent.OS)" | **/pom.xml'
              restoreKeys: |
                maven | "$(Agent.OS)"
                maven
              path: $(MAVEN_CACHE_FOLDER)

          # =============================================
          # STEP 7: Install Anypoint CLI
          # =============================================
          - script: |
              echo "üì¶ Installing Anypoint CLI..."
              npm install -g anypoint-cli@latest
              
              echo ""
              echo "‚úÖ Anypoint CLI installed:"
              anypoint-cli --version
              
            displayName: 'Install Anypoint CLI'

         # =============================================
          # STEP 8: API Governance Validation (Connected App)
          # =============================================
          - script: |
              echo "üõ°Ô∏è Running API Governance Validation..."
              echo ""
              
              # Check if Anypoint credentials are configured
              if [ -z "$(anypointClientId)" ] || [ -z "$(anypointClientSecret)" ]; then
                echo "‚ö†Ô∏è Anypoint CLI credentials not configured"
                echo "   Variables 'anypointClientId' and 'anypointClientSecret' are missing"
                echo "   Skipping governance validation..."
                exit 0
              fi
              
              # Create project ZIP
              if [ ! -f "$(PROJECT_NAME).zip" ]; then
                echo "Creating project ZIP..."
                zip -r $(PROJECT_NAME).zip . -x "*.git*" -x "target/*" -x "*.zip"
                echo "‚úÖ ZIP created: $(PROJECT_NAME).zip"
              fi
              
              echo ""
              echo "üîê Authentication: Connected App"
              echo "   Client ID: $(anypointClientId)"
              echo "   Organization: $(MULE_ORG)"
              echo ""
              echo "Running validation..."
              
              # ‚úÖ Use Connected App authentication (--client_id, --client_secret)
              anypoint-cli \
                --client_id='$(anypointClientId)' \
                --client_secret='$(anypointClientSecret)' \
                --organization='$(MULE_ORG)' \
                governance api validate \
                --rulesets ruleset.yaml \
                $(PROJECT_NAME).zip || {
                  echo ""
                  echo "‚ö†Ô∏è Governance validation failed or not configured"
                  echo "   Possible reasons:"
                  echo "   - No ruleset.yaml file in project"
                  echo "   - API Governance not enabled in org"
                  echo "   - Connected App needs 'Design Center Developer' scope"
                  echo ""
                  echo "   This is non-blocking, continuing..."
                }
              
              echo ""
              echo "‚úÖ Governance step completed"
              
            displayName: 'API Governance Validation (Connected App)'
            continueOnError: true
            condition: and(succeeded(), ne(variables['MULE_ORG'], ''))

          # =============================================
          # STEP 9: Maven Validate
          # =============================================
          - script: |
              export M2_HOME=$(MAVEN_HOME)
              export PATH=$(MAVEN_HOME)/bin:$PATH
              
              echo "üîç Running Maven validate..."
              echo ""
              
              mvn validate \
                -Dmaven.repo.local=$(MAVEN_CACHE_FOLDER) \
                -s ~/.m2/settings.xml \
                -e
              
              echo ""
              echo "‚úÖ Validation completed"
              
            displayName: 'Maven Validate'
            continueOnError: true
            env:
              M2_HOME: $(MAVEN_HOME)

          # # =============================================
          # # STEP 10: MUnit Tests
          # # =============================================
          # - script: |
          #     export M2_HOME=$(MAVEN_HOME)
          #     export PATH=$(MAVEN_HOME)/bin:$PATH
              
          #     echo "üß™ Running MUnit tests..."
          #     echo ""
              
          #     mvn test \
          #       -Dmaven.repo.local=$(MAVEN_CACHE_FOLDER) \
          #       -Dsecure.key=mule \
          #       -Dmule.env=dev \
          #       -Dproject.version=1.0.0 \
          #       -s ~/.m2/settings.xml \
          #       -e
              
          #     echo ""
          #     echo "‚úÖ Tests completed"
              
          #     # Show test results summary
          #     if [ -d target/surefire-reports ]; then
          #       echo ""
          #       echo "üìä Test Results:"
          #       find target/surefire-reports -name "*.xml" -exec basename {} \; | head -10
          #     fi
              
          #   displayName: 'MUnit Tests'
          #   continueOnError: false
          #   env:
          #     M2_HOME: $(MAVEN_HOME)

          # # =============================================
          # # STEP 11: Publish Test Results
          # # =============================================
          # - task: PublishTestResults@2
          #   displayName: 'Publish MUnit Test Results'
          #   condition: succeededOrFailed()
          #   inputs:
          #     testResultsFormat: 'JUnit'
          #     testResultsFiles: '**/surefire-reports/TEST-*.xml'
          #     mergeTestResults: true
          #     failTaskOnFailedTests: false
          #     testRunTitle: 'MUnit Test Results'
          #     publishRunAttachments: true

          # =============================================
          # STEP 12: Maven Package
          # =============================================
          - script: |
              export M2_HOME=$(MAVEN_HOME)
              export PATH=$(MAVEN_HOME)/bin:$PATH
              
              echo "üì¶ Running Maven package..."
              echo ""
              
              mvn clean package \
                -Dmaven.repo.local=$(MAVEN_CACHE_FOLDER) \
                -Dsecure.key=mule \
                -Dmule.env=dev \
                -DskipTests \
                -s ~/.m2/settings.xml \
                -e
              
              echo ""
              echo "‚úÖ Package completed"
              echo ""
              
              # Show artifacts
              echo "üì¶ Build Artifacts:"
              if [ -d target ]; then
                ls -lh target/*.jar 2>/dev/null || ls -lh target/ || echo "   No JAR files found"
              else
                echo "   ‚ö†Ô∏è target/ directory not found"
              fi
              
            displayName: 'Maven Package'
            env:
              M2_HOME: $(MAVEN_HOME)

          # # =============================================
          # # STEP 13: SonarQube Analysis (Optional)
          # # =============================================
          # - script: |
          #     export M2_HOME=$(MAVEN_HOME)
          #     export PATH=$(MAVEN_HOME)/bin:$PATH
              
          #     echo "üîç SonarQube Analysis..."
          #     echo ""
              
          #     if [ -n "$(SONAR_TOKEN)" ] && [ -n "$(SONAR_HOST_URL)" ]; then
          #       echo "Running SonarQube analysis..."
                
          #       mvn sonar:sonar \
          #         -Dsonar.host.url=$(SONAR_HOST_URL) \
          #         -Dsonar.login=$(SONAR_TOKEN) \
          #         -Dsonar.projectKey=$(PROJECT_NAME) \
          #         -Dsonar.projectName=$(PROJECT_NAME) \
          #         -s ~/.m2/settings.xml || {
          #           echo "‚ö†Ô∏è SonarQube analysis failed (non-blocking)"
          #         }
                
          #       echo ""
          #       echo "‚úÖ SonarQube step completed"
          #     else
          #       echo "‚ö†Ô∏è SonarQube not configured (SONAR_TOKEN or SONAR_HOST_URL missing)"
          #       echo "   Skipping analysis..."
          #     fi
              
          #   displayName: 'SonarQube Analysis'
          #   continueOnError: true
          #   condition: succeededOrFailed()
          #   env:
          #     M2_HOME: $(MAVEN_HOME)

          # =============================================
          # STEP 14: Copy Build Artifacts
          # =============================================
          - task: CopyFiles@2
            displayName: 'Copy Build Artifacts'
            inputs:
              Contents: |
                **/target/*.jar
                pom.xml
              TargetFolder: $(Build.ArtifactStagingDirectory)
              flattenFolders: false

          # =============================================
          # STEP 15: Publish Pipeline Artifacts
          # =============================================
          - task: PublishPipelineArtifact@1
            displayName: 'Publish Pipeline Artifacts'
            inputs:
              targetPath: $(Build.ArtifactStagingDirectory)
              artifact: 'drop'

  # #####################################################
  # # DEPLOY STAGE: CloudHub Deployment
  # #####################################################
  # - stage: Deploy
  #   displayName: 'Deploy to CloudHub'
  #   dependsOn: Build
  #   condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  #   jobs:
  #     - deployment: DeployToCloudHub
  #       displayName: 'Deploy to CloudHub Sandbox'
  #       environment: 'Sandbox'
  #       strategy:
  #         runOnce:
  #           deploy:
  #             steps:
  #               # =========================================
  #               # Re-install Maven for Deploy Stage
  #               # =========================================
  #               - script: |
  #                   set -e
                    
  #                   echo "üîß Setting up Maven $(MAVEN_VERSION) for deployment..."
                    
  #                   MAVEN_URL="https://archive.apache.org/dist/maven/maven-3/$(MAVEN_VERSION)/binaries/apache-maven-$(MAVEN_VERSION)-bin.tar.gz"
  #                   MAVEN_ARCHIVE="maven.tar.gz"
                    
  #                   # Download
  #                   if wget --progress=dot:giga --timeout=60 --tries=3 -O "$MAVEN_ARCHIVE" "$MAVEN_URL"; then
  #                     echo "‚úÖ Downloaded"
  #                   elif curl -fsSL --max-time 120 --retry 3 -o "$MAVEN_ARCHIVE" "$MAVEN_URL"; then
  #                     echo "‚úÖ Downloaded"
  #                   else
  #                     echo "‚ùå Download failed"
  #                     exit 1
  #                   fi
                    
  #                   # Extract and install
  #                   tar -xzf "$MAVEN_ARCHIVE"
  #                   sudo rm -rf $(MAVEN_HOME) 2>/dev/null || true
  #                   sudo mv apache-maven-$(MAVEN_VERSION) $(MAVEN_HOME)
  #                   sudo chmod -R 755 $(MAVEN_HOME)
                    
  #                   echo "‚úÖ Maven ready:"
  #                   $(MAVEN_HOME)/bin/mvn --version
                    
  #                   rm -f "$MAVEN_ARCHIVE"
                    
  #                 displayName: 'Setup Maven for Deploy'
                
  #               # =========================================
  #               # Re-download settings.xml
  #               # =========================================
  #               - task: DownloadSecureFile@1
  #                 name: mavenSettingsDeploy
  #                 displayName: 'Download Maven Settings'
  #                 inputs:
  #                   secureFile: 'settings.xml'
                
  #               - script: |
  #                   echo "üì¶ Installing settings.xml for deployment..."
  #                   mkdir -p ~/.m2
  #                   cp $(mavenSettingsDeploy.secureFilePath) ~/.m2/settings.xml
                    
  #                   if [ -f ~/.m2/settings.xml ]; then
  #                     echo "‚úÖ settings.xml installed"
  #                   else
  #                     echo "‚ùå ERROR: settings.xml not found"
  #                     exit 1
  #                   fi
                    
  #                 displayName: 'Install Maven Settings for Deploy'

  #               # =========================================
  #               # Download Build Artifacts
  #               # =========================================
  #               - download: current
  #                 artifact: drop
  #                 displayName: 'Download Build Artifacts'

  #               # # =========================================
  #               # # Deploy to CloudHub
  #               # # =========================================
  #               # - script: |
  #               #     export M2_HOME=$(MAVEN_HOME)
  #               #     export PATH=$(MAVEN_HOME)/bin:$PATH
                    
  #               #     echo "=================================================="
  #               #     echo "  CloudHub Deployment"
  #               #     echo "=================================================="
  #               #     echo ""
                    
  #               #     cd $(Pipeline.Workspace)/drop
                    
  #               #     echo "üì¶ Workspace contents:"
  #               #     ls -la
  #               #     echo ""
                    
  #               #     echo "üöÄ Deploying to CloudHub Sandbox..."
  #               #     echo ""
                    
  #               #     mvn deploy \
  #               #       -DskipTests \
  #               #       -Dmule.version=4.9.0 \
  #               #       -Dcloudhub.environment=Sandbox \
  #               #       -Dcloudhub.workerType=MICRO \
  #               #       -Dcloudhub.workers=1 \
  #               #       -Dcloudhub.region=us-east-2 \
  #               #       -Danypoint.username='$(anypointUsername)' \
  #               #       -Danypoint.password='$(anypointPassword)' \
  #               #       -DmuleDeploy \
  #               #       -s ~/.m2/settings.xml \
  #               #       -e
                    
  #               #     echo ""
  #               #     echo "=================================================="
  #               #     echo "  ‚úÖ Deployment Completed Successfully"
  #               #     echo "=================================================="
  #               #     echo ""
  #               #     echo "Application: $(PROJECT_NAME)"
  #               #     echo "Environment: Sandbox"
  #               #     echo "Region: us-east-2"
  #               #     echo "Workers: 1 x MICRO"
  #               #     echo ""
                    
  #               #   displayName: 'Deploy to CloudHub'
  #               #   env:
  #               #     M2_HOME: $(MAVEN_HOME)
                
  #               # # =========================================
  #               # # Verify Deployment (Optional)
  #               # # =========================================
  #               # - script: |
  #               #     echo "üîç Verifying deployment..."
  #               #     echo ""
                    
  #               #     # Wait for app to start
  #               #     echo "Waiting 30 seconds for application to start..."
  #               #     sleep 30
                    
  #               #     # Check deployment status using Anypoint CLI
  #               #     anypoint-cli \
  #               #       --username='$(anypointUsername)' \
  #               #       --password='$(anypointPassword)' \
  #               #       runtime-mgr cloudhub-application describe $(PROJECT_NAME) || {
  #               #         echo "‚ö†Ô∏è Could not verify deployment status"
  #               #         echo "   This is non-blocking"
  #               #       }
                    
  #               #     echo ""
  #               #     echo "‚úÖ Verification complete"
                    
  #               #   displayName: 'Verify Deployment'
  #               #   continueOnError: true
